#!/usr/bin/env bash

set -euo pipefail

DOTFILES="${DOTFILES:-$HOME/Code/hiradp/home}"
DEFAULT_FOLDERS="fish ghostty git nvim starship tmux"

# ------------------------------------------------------------------------------
# Commands
# ------------------------------------------------------------------------------

cmd_link() {
  local folders="${*:-$DEFAULT_FOLDERS}"
  local stow="/opt/homebrew/bin/stow"

  for folder in $folders; do
    echo "Linking $folder..."
    $stow -d "$DOTFILES/config" -D "$folder" 2>/dev/null || true
    $stow -d "$DOTFILES/config" "$folder" -t "$HOME"
  done

  echo "Done!"
}

cmd_install() {
  local type="${1:-all}"

  case "$type" in
  essentials)
    _install_from_file "$DOTFILES/pkg/brew/essentials"
    ;;
  casks)
    _install_from_file "$DOTFILES/pkg/brew/cask" --cask
    ;;
  all)
    _install_from_file "$DOTFILES/pkg/brew/essentials"
    _install_from_file "$DOTFILES/pkg/brew/cask" --cask
    ;;
  *)
    echo "Unknown install type: $type" >&2
    echo "Valid types: essentials, casks, all" >&2
    exit 1
    ;;
  esac

  echo "Done!"
}

cmd_setup() {
  echo "==> Running first-time setup..."

  echo ""
  echo "==> Installing Homebrew..."
  _install_homebrew

  echo ""
  echo "==> Setting up SSH keys..."
  _setup_ssh

  echo ""
  echo "==> Installing brew packages..."
  cmd_install

  echo ""
  echo "==> Linking dotfiles..."
  cmd_link

  echo ""
  echo "==> Setup complete!"
}

cmd_help() {
  cat <<EOF
home - dotfiles manager

Usage: home <command> [args]

Commands:
  setup                 First-time setup (install + link)
  install [type]        Install brew packages (essentials, casks, all)
  link [folders...]     Link configs to ~ using stow (default: all)
  help                  Show this help message

Environment:
  DOTFILES              Path to dotfiles repo (default: ~/Code/hiradp/home)

Examples:
  home setup                First-time machine setup
  home install              Install all brew packages
  home install essentials   Install only CLI tools
  home install casks        Install only GUI apps
  home link                 Link all config folders
  home link nvim fish       Link only nvim and fish configs
EOF
}

# ------------------------------------------------------------------------------
# Helpers
# ------------------------------------------------------------------------------

_install_homebrew() {
  if command -v brew &>/dev/null; then
    echo "Homebrew already installed"
  else
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    echo "Homebrew installed"
  fi
  eval "$(/opt/homebrew/bin/brew shellenv)"
}

_setup_ssh() {
  local ssh_dir="$HOME/.ssh"
  local vault_dir="$HOME/Library/Mobile Documents/com~apple~CloudDocs/Documents/Vault"
  local config_file="$ssh_dir/config"

  mkdir -p "$ssh_dir"

  if [[ -f "$ssh_dir/id_ed25519" ]]; then
    echo "SSH keys already exist"
  else
    if [[ -f "$vault_dir/id_ed25519" ]]; then
      cp "$vault_dir/id_ed25519" "$ssh_dir/id_ed25519"
      cp "$vault_dir/id_ed25519.pub" "$ssh_dir/id_ed25519.pub"
      chmod 600 "$ssh_dir/id_ed25519"
      chmod 644 "$ssh_dir/id_ed25519.pub"
      echo "SSH keys copied and permissions set"
    else
      echo "Warning: SSH keys not found in iCloud vault" >&2
      echo "Expected location: $vault_dir" >&2
      return 0
    fi
  fi

  # Configure SSH to use Apple Keychain
  if ! grep -q "UseKeychain yes" "$config_file" 2>/dev/null; then
    cat >>"$config_file" <<EOF

Host *
  AddKeysToAgent yes
  UseKeychain yes
  IdentityFile ~/.ssh/id_ed25519
EOF
    chmod 600 "$config_file"
    echo "SSH config updated to use Apple Keychain"
  fi

  # Add key to agent with keychain storage
  ssh-add --apple-use-keychain "$ssh_dir/id_ed25519" 2>/dev/null || true
}

_install_from_file() {
  local file="$1"
  local flag="${2:-}"

  if [[ ! -f "$file" ]]; then
    echo "File not found: $file" >&2
    exit 1
  fi

  while IFS= read -r package || [[ -n "$package" ]]; do
    [[ -z "$package" || "$package" =~ ^# ]] && continue
    echo "Installing $package..."
    brew install $flag "$package" </dev/null
  done <"$file"
}

# ------------------------------------------------------------------------------
# Main
# ------------------------------------------------------------------------------

main() {
  local cmd="${1:-help}"
  shift || true

  case "$cmd" in
  setup) cmd_setup ;;
  install) cmd_install "$@" ;;
  link) cmd_link "$@" ;;
  help | --help | -h) cmd_help ;;
  *)
    echo "Unknown command: $cmd" >&2
    cmd_help
    exit 1
    ;;
  esac
}

main "$@"
