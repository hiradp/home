#!/usr/bin/env bash

set -euo pipefail

DOTFILES="${DOTFILES:-$HOME/Code/hiradp/home}"
DEFAULT_FOLDERS="fish ghostty git nvim starship tmux"

# Source logging library
source "$DOTFILES/lib/log.sh"

# ------------------------------------------------------------------------------
# Commands
# ------------------------------------------------------------------------------

cmd_link() {
  local folders="${*:-$DEFAULT_FOLDERS}"
  local stow="/opt/homebrew/bin/stow"

  for folder in $folders; do
    log_info "Linking $folder..."
    $stow -d "$DOTFILES/config" -D "$folder" 2>/dev/null || true
    $stow -d "$DOTFILES/config" "$folder" -t "$HOME"
  done

  log_ok "Linked"
}

cmd_install() {
  local type="${1:-all}"

  case "$type" in
  essentials)
    _install_from_file "$DOTFILES/pkg/brew/essentials"
    ;;
  casks)
    _install_from_file "$DOTFILES/pkg/brew/cask" --cask
    ;;
  langs)
    _install_langs
    ;;
  all)
    _install_from_file "$DOTFILES/pkg/brew/essentials"
    _install_from_file "$DOTFILES/pkg/brew/cask" --cask
    _install_langs
    ;;
  *)
    log_error "Unknown install type: $type"
    log_info "Valid types: essentials, casks, langs, all"
    exit 1
    ;;
  esac

  log_ok "Installed"
}

cmd_setup() {
  log_banner "Home Setup"

  log_section "Installing Homebrew"
  _install_homebrew

  log_section "Setting up SSH keys"
  _setup_ssh

  log_section "Installing brew packages"
  cmd_install

  log_section "Linking dotfiles"
  cmd_link

  log_banner "Setup complete"
}

cmd_help() {
  cat <<EOF
home - dotfiles manager

Usage: home <command> [args]

Commands:
  setup                 First-time setup (install + link)
  install [type]        Install packages (essentials, casks, langs, all)
  link [folders...]     Link configs to ~ using stow (default: all)
  help                  Show this help message

Environment:
  DOTFILES              Path to dotfiles repo (default: ~/Code/hiradp/home)

Examples:
  home setup                First-time machine setup
  home install              Install all packages
  home install essentials   Install only CLI tools
  home install casks        Install only GUI apps
  home install langs        Install language runtimes (Node.js via nvm)
  home link                 Link all config folders
  home link nvim fish       Link only nvim and fish configs
EOF
}

# ------------------------------------------------------------------------------
# Helpers
# ------------------------------------------------------------------------------

_install_homebrew() {
  if command -v brew &>/dev/null; then
    log_info "Already installed"
  else
    log_info "Installing..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    log_ok "Installed"
  fi
  eval "$(/opt/homebrew/bin/brew shellenv)"
}

_setup_ssh() {
  local ssh_dir="$HOME/.ssh"
  local vault_dir="$HOME/Library/Mobile Documents/com~apple~CloudDocs/Documents/Vault"
  local config_file="$ssh_dir/config"

  mkdir -p "$ssh_dir"

  if [[ -f "$ssh_dir/id_ed25519" ]]; then
    log_info "SSH keys already exist"
  else
    if [[ -f "$vault_dir/id_ed25519" ]]; then
      cp "$vault_dir/id_ed25519" "$ssh_dir/id_ed25519"
      cp "$vault_dir/id_ed25519.pub" "$ssh_dir/id_ed25519.pub"
      chmod 600 "$ssh_dir/id_ed25519"
      chmod 644 "$ssh_dir/id_ed25519.pub"
      log_ok "SSH keys copied from iCloud"
    else
      log_warn "SSH keys not found in iCloud vault"
      log_dim "Expected: $vault_dir"
      return 0
    fi
  fi

  if ! grep -q "UseKeychain yes" "$config_file" 2>/dev/null; then
    cat >>"$config_file" <<EOF

Host *
  AddKeysToAgent yes
  UseKeychain yes
  IdentityFile ~/.ssh/id_ed25519
EOF
    chmod 600 "$config_file"
    log_info "SSH config updated for Apple Keychain"
  fi

  ssh-add --apple-use-keychain "$ssh_dir/id_ed25519" 2>/dev/null || true
}

_install_from_file() {
  local file="$1"
  local flag="${2:-}"

  if [[ ! -f "$file" ]]; then
    log_error "File not found: $file"
    exit 1
  fi

  while IFS= read -r package || [[ -n "$package" ]]; do
    [[ -z "$package" || "$package" =~ ^# ]] && continue
    log_dim "Installing $package..."
    brew install $flag "$package" </dev/null
  done <"$file"
}

_install_langs() {
  log_info "Installing language runtimes..."
  for script in "$DOTFILES/pkg/lang"/*; do
    [[ -f "$script" ]] || continue
    log_dim "$(basename "$script")"
    source "$script"
  done
}

# ------------------------------------------------------------------------------
# Main
# ------------------------------------------------------------------------------

main() {
  local cmd="${1:-help}"
  shift || true

  case "$cmd" in
  setup) cmd_setup ;;
  install) cmd_install "$@" ;;
  link) cmd_link "$@" ;;
  help | --help | -h) cmd_help ;;
  *)
    log_error "Unknown command: $cmd"
    cmd_help
    exit 1
    ;;
  esac
}

main "$@"
