#!/usr/bin/env bash
#
# Bootstrap script for setting up a fresh Mac
# Usage: curl -fsSL https://raw.githubusercontent.com/hiradp/home/main/bin/bootstrap | bash
#
set -euo pipefail

REPO_URL="https://github.com/hiradp/home.git"
SSH_URL="git@github.com:hiradp/home.git"
DOTFILES="$HOME/Code/hiradp/home"

# ------------------------------------------------------------------------------
# Logging (inline for bootstrap - runs before repo is cloned)
# ------------------------------------------------------------------------------

if [[ -t 1 ]]; then
  _LOG_GREEN='\033[32m'
  _LOG_RED='\033[31m'
  _LOG_DIM='\033[2m'
  _LOG_RESET='\033[0m'
else
  _LOG_GREEN=''
  _LOG_RED=''
  _LOG_DIM=''
  _LOG_RESET=''
fi

log_banner() { echo ""; echo "─── $1 ───"; echo ""; }
log_section() { echo ""; echo "▸ $1"; }
log_info() { echo "  $1"; }
log_ok() { echo -e "  ${_LOG_GREEN}✓${_LOG_RESET} $1"; }
log_dim() { echo -e "  ${_LOG_DIM}$1${_LOG_RESET}"; }

# ------------------------------------------------------------------------------
# Helpers
# ------------------------------------------------------------------------------

_install_xcode_cli() {
  if xcode-select -p &>/dev/null; then
    log_info "Already installed"
  else
    log_info "Installing..."
    xcode-select --install
    log_dim "A dialog should appear - click 'Install' to proceed"
    until xcode-select -p &>/dev/null; do
      sleep 5
    done
    log_ok "Installed"
  fi
}

# ------------------------------------------------------------------------------
# Main
# ------------------------------------------------------------------------------

log_banner "Home Bootstrap"

log_section "Installing Xcode CLI tools"
_install_xcode_cli

log_section "Cloning dotfiles"
mkdir -p "$(dirname "$DOTFILES")"
if [[ -d "$DOTFILES" ]]; then
  log_info "Repo exists at $DOTFILES"
  log_info "Pulling latest..."
  if git -C "$DOTFILES" pull --ff-only 2>/dev/null; then
    log_ok "Up to date"
  else
    log_dim "Already up to date"
  fi
else
  git clone "$REPO_URL" "$DOTFILES"
  log_ok "Cloned to $DOTFILES"
fi

log_section "Running setup"
"$DOTFILES/bin/home" setup </dev/tty

log_section "Switching to SSH remote"
git -C "$DOTFILES" remote set-url origin "$SSH_URL"
log_ok "Remote updated"

log_banner "Bootstrap complete"

echo "  Dotfiles: $DOTFILES"
echo "  Run 'home help' for commands"
echo ""
